<div align='center'>
    <h1>TUP_2024_Dart</h1>
</div>

# 简介

本项目是TUP战队2024赛季飞镖发射架的电控代码。基于2023赛季的旧C++框架编写，应用层具备良好的扩展性。底层的bsp、app等代码的结构并非完美，但应用层在编写时贯彻了C++面向对象的编程思想，类间的嵌套对应到发射架相应的机构，逻辑明确，易于理解。代码在设计时对大部分操作都做好了防误触保护，包含大量的遥控器内八外八打杆方式，保证了调试和比赛时的人员及结构安全。发射架包含一个串口屏调参模块，可实现对参数的快速更改和对发射架重要数据的监视，即使不携带电脑也能正常进行飞镖测试，在发射架出现异常时也可根据监视的数据快速诊断问题所在，大幅提升了调试的便捷性。发射架的运行不依赖裁判系统串口数据，可避免裁判系统数据延迟等带来的潜在问题。

# 遥控器操作逻辑

遥控器的右拨杆控制主模式，左拨杆控制子模式。除无力模式外，每个主模式下都有三个子模式。

## 模式总览

- 右拨杆下：无力模式
- 右拨杆中：校准模式
  - 左拨杆下：调整
  - 左拨杆中：校准
  - 左拨杆上：检查校准点
- 右拨杆上：发射模式
  - 左拨杆下：发射初始化
  - 左拨杆中：手动发射
  - 左拨杆上：云台手模式

## 模式详情

### 无力模式

- 摩擦轮使用速度环控制停转，其他电机发送零电流关闭输出
- 程序正常运行时无力模式才能发挥急停功能，当程序运行出错疯车时应直接切断电源

### 校准模式

校准主模式用于校准发射架的各项参数，也可以手动控制除摩擦轮外的各个机构运动

#### 调整（↓-）

- 调整装填电机和转盘
  - 右摇杆前后调整装填电机位置，左右调整转盘位置
- 调整yaw轴
  - 左摇杆左右调整yaw轴
- 其他说明
  - 装填电机未校准时，装填电机和转盘无法移动，但yaw轴可以移动
  - 装填推块位于载弹架中时，转盘无法转动
  - 载弹架的空位没有正对推块时，装填电机无法前移

#### 校准（--）

- 校准装填电机
  - 自动校准
    - ↙️↘️开始自动校准装填电机，滑块会自动下移寻找零点，接触到触点开关后上移一定距离，完成校准
    - 底部触点开关被压下时会有蜂鸣器反馈
    - 若滑块下移至最底部还不自动上移，说明触点开关相关线路工作不正常，请立即退出校准模式防止损伤机械结构
  - 手动校准
    - ↘️↙️保持，进行手动校准，以当前位置作为滑块零点，听到蜂鸣器响完成校准
    - 拨杆拨动到校准位置（--），手动拖动推块至最底部，直到触点开关被压下，然后手动转动装填电机转子端使推块上移至刚好离开触点开关金属片的位置（不是刚好使触点开关弹起的位置），此时的位置可作为零点
    - 手动校准后必须用遥控器控制转盘旋转，检查弹仓是否会与推块干涉，若干涉则需要重新校准
- 校准yaw轴
  - ↗️↖️校准yaw轴，以当前位置作为发射时偏移量的零点，听到蜂鸣器响完成校准
  - 校准模式下yaw轴电机不输出扭矩，可在调整模式下先将yaw轴移动到需要校准的位置附近，进入校准模式后用手转动yaw轴转子细调零点
- 其他说明
  - 每次上电或C板reset后都需要重新校准

#### 检查校准点（↑-）

- ↗↖检查校准点，yaw轴会自动返回校准的零点

### 发射模式

发射模式用于发射初始化并发射飞镖。发射机构正常进行发射动作时摩擦轮可以选择不转动，用于模拟推弹检查各机构运行是否正常。

#### 发射初始化（↓↑）

- 发射初始化

  发射初始化有四种打杆方式，可以选择从四发飞镖中的第几发开始发射。初始化时装填电机退回零点，转盘转动将指定的飞镖移动至发射轨道上，yaw轴移动至指定飞镖对应的前哨站偏移量
  - ↗↖初始化为第一发飞镖
  - ↖↖初始化为第二发飞镖
  - ↙↖初始化为第三发飞镖
  - ↘↖初始化为第四发飞镖
  - 无论左右拨杆，离开再重新回到发射初始化模式（↓↑）后，都需要重新初始化

- 开启摩擦轮
  - ↖↗开启摩擦轮，摩擦轮将以初始化的飞镖对应的前哨站设定转速旋转，若未初始化则以第一发飞镖的前哨站设定转速旋转
  - 离开发射模式主模式（右拨杆上）后，摩擦轮自动停止。发射模式主模式下，离开再重回发射初始化模式（↓↑）或所有飞镖打空后，摩擦轮自动停止

#### 手动发射（-↑）

手动发射具有更好的可控性，适用于场下调试

- 发射飞镖
  - 左摇杆向↖打一次发射一枚飞镖，发射架将执行：装填推块推动飞镖上移发射→装填推块下移返回零点→摩擦轮转速变为下一发飞镖对应的设定转速→转盘转动将下一发飞镖移动至发射轨道上→yaw轴移动至下一发飞镖对应的设定位置（为了节省装弹时间，部分步骤会同时进行）（后续将此简称为“发射流程”）。完成以上所有步骤后，发射架才会对遥控器打杆再次做出响应，发射下一发飞镖。
  - 需要连续发射四发飞镖时左摇杆可一直保持↖状态，不必反复回中
  - 不开启摩擦轮时也能进行发射流程，可用于模拟推弹检查各机构运行是否正常
  - 未完成发射初始化时无法进行发射流程
- 切换打击目标
  - ↙↙设置未发射的飞镖打击目标为前哨站，↘↘设置未发射的飞镖打击目标为基地，未设置目标则默认为前哨站
  - 每次进入发射模式主模式（右拨杆上）或发射初始化子模式（↓↑），打击目标都会被自动重置为前哨站

#### 自动发射（↑↑）

自动发射操作简单，可实现一键完成发射，适用于赛场上云台手操作飞镖

- 发射飞镖
  - 左摇杆向↖打一次发射一枚飞镖，发射架在执行发射流程前后将自动控制摩擦轮启停，即：摩擦轮开启→发射流程→摩擦轮停止
  - 需要连续发射多发飞镖时左摇杆可一直保持↖状态，不必反复回中，每发飞镖之间摩擦轮不会再停止
  - 自动发射会自动控制摩擦轮启停，无需在发射初始化时开启摩擦轮
  - 未完成发射初始化时无法进行自动发射

# 串口屏操作逻辑

## 开机动画

原神，启动！

## 主页

- 主页左半部分为串口屏四大功能，点击即可进入相应页面。
- 右半部分显示发射架的几项重要信息，自上而下具体如下：
  - 飞镖索引：可理解为已经发射的飞镖数量
  - 发射初始化状态：未进行发射初始化时显示红色的`Uninitialized`，初始化完毕后显示白色的`Initialized`
  - 打击目标
  - 发射架主模式：根据遥控器右拨杆设置的发射架主模式，会显示为`ZERO FORCE`（无力模式）、`CALIBRATE`（校准模式）、`SHOOT`（发射模式）
  - 自动发射：发射架处于自动发射状态（↑↑）时显示`Auto: OFF`，否则显示`Auto: OFF`

<img src="image/img_main_page.png" alt="主页" width="80%">

## 补偿量调整

右上角为刷新按键，点击可获取C板内存储的所有补偿数据并在本页面显示。右下角为跳转至摩擦轮监视页面的快捷按键。

点击想要更改的数据可使用弹出的小键盘进行更改，摩擦轮转速必须为整数，yaw轴补偿可以为小数。输入完数据按OK后，检查本页面显示的数据是否与在小键盘中输入的相同，如果不相同说明C板没有成功接收到输入的数据，需要重新输入。输入完所有数据后，点击几次刷新键检查本页面显示的数据是否都与预期的一致，出现不一致的数据需要重新输入。

<img src="image/img_offset_page.png" alt="补偿量调整页面" width="80%">

## 警告信息

本页面左半部分显示发射架各模块的初始化及校准警告，其中`装填电机受限`表示载弹架的空位没有正对装填推块，推块受限无法前移。右半部分显示各模块的离线警告。出现警告时本页面显示对应的文字提示，警告消除时文字消失。在完成发射初始化准备发射时，应确保本页面不显示任何警告信息。

<img src="image/img_warning_page.png" alt="警告信息页面" width="80%">

## 摩擦轮监视

本页面可监视四个摩擦轮电机的各项数据，右下角为跳转至补偿量调整页面的快捷按键。被复选框勾选的数据将以1.25Hz的频率进行更新，勾选的数量不会影响数据的刷新率，但串口屏性能有限，勾选过多的数据可能导致爆栈白屏。爆栈后将串口屏断电重启即可恢复。

<img src="image/img_fric_monitor_page.png" alt="摩擦轮监视页面" width="80%">

## 其它监视

本页面可监视yaw轴、装填、转盘电机的各项数据，操作逻辑和注意事项与摩擦轮监视页面相同。yaw轴电机和装填电机的`ANGLE`为无效数据，即使勾选也不会刷新。

<img src="image/img_other_monitor_page.png" alt="其它监视页面" width="80%">

# 操作流程

1. 开启遥控器并将拨杆打到无力模式（↓↓），给发射架上电
2. 校准装填电机（--）
3. 移动yaw轴使激光点瞄准前哨站（↓-）
4. 校准yaw轴（--）
5. 在串口屏上输入各个镖体的补偿参数
6. 发射初始化（↓↑）
7. 检查串口屏是否有警告信息
8. 发射飞镖（-↑或↑↑）

# 部分故障及原因

|故障表现|原因|
|---|---|
|串口屏主页飞镖索引长时间显示-1|通信异常，串口屏无法接收到C板发送的数据|
|串口屏补偿量调整页面所有数据显示99999|通信异常，串口屏无法接收到C板发送的数据|

# 配件选型

## 发射架

|配件|型号|
|---|---|
|摩擦轮电机|RoboMaster M3508转子端|
|YAW轴电机|RoboMaster M3508|
|转盘电机|RoboMaster GM6020|
|装填电机|RoboMaster M2006|
|开发板|RoboMaster开发板 C 型|
|串口屏|淘晶驰T1系列4.3寸IPS电容屏模块|
|激光器|RoboMaster 红点激光器|
|*OLED屏|0.96寸|
|YAW轴拖链|10*20|
|装填电机拖链|10*10|
|24V电源线|18AWG硅胶线|
|5V电源线|26AWG硅胶线|
|信号线|26AWG硅胶线|
|温湿度计|德力西DM-1059|
|扎带固定座|可调式扎带固定座 CL-2|

*截至此文档创建时，发射架的OLED屏已被串口屏替代不再使用，但程序中仍保留有相关代码，方便根据需求重新启用

## 飞镖

|配件|型号|
|---|---|
|电池|3.7V 402030锂电池|
|电池端供电插头|SH1.0|

# 电机ID配置

|电机|型号|CAN总线|ID|
|---|---|---|---|
|左前摩擦轮|M3508|CAN1|1|
|右前摩擦轮|M3508|CAN1|2|
|左后摩擦轮|M3508|CAN1|3|
|右后摩擦轮|M3508|CAN1|4|
|YAW轴|M3508|CAN2|1|
|转盘|GM6020|CAN2|1|
|装填推块|M2006|CAN2|6|

# 布线规范

# 程序设计思路

# 调参方法